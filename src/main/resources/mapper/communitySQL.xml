<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="community">
	<select id="selectCommunityList" resultType="comm" parameterType="map">
		select * from
			(select rownum as rnum, c.* from
			(select 
			    comm.comm_no as commNo,
			    comm_category as commCategory,
			    member_no as memberNo,
			    (select member_nick from member_tbl m where comm.member_no = m.member_no) as memberNick, --멤버닉
			    (select grade from member_tbl m where comm.member_no = m.member_no) as memberGrade, --멤버등급
			    (select member_picturepath from member_tbl m where comm.member_no = m.member_no) as memberPicturepath, --멤버프로필사진
			    comm_title as commTitle,
			    comm_intro as commIntro,
			    read_count as readCount,
			    comm_date as commDate,
			    comm_like as commLike,
			    comm_filename as commFilename,
			    comm_filepath as commFilepath,
			(select nvl(count(*),0) from communityco_tbl co where co.comm_no = comm.comm_no) as cmntCount
		from community_tbl comm 
		<if test="category != 2">
		where comm_category = #{category}
		</if>
		order by comm.comm_no desc) c)
		where rnum between #{start} and #{end}
	</select> 
	<select id="selectTotalCount" resultType="int" parameterType="map">
		select count(*) from community_tbl
		<if test="category != 2">
		where comm_category = #{category}
		</if>
	</select>
	
	<select id="communityDetail" resultType="comm" parameterType="int">
		select 
			    comm.comm_no as commNo,
			    comm_category as commCategory,
			    member_no as memberNo,
			    (select member_nick from member_tbl m where comm.member_no = m.member_no) as memberNick, --멤버닉
			    (select grade from member_tbl m where comm.member_no = m.member_no) as memberGrade, --멤버등급
			    (select member_picturepath from member_tbl m where comm.member_no = m.member_no) as memberPicturepath, --멤버프로필사진
			    comm_title as commTitle,
			    comm_intro as commIntro,
			    read_count as readCount,
			    comm_content as commContent,
			    advantage,
			    weakness,
			    comm_date as commDate,
			    comm_like as commLike,
			    comm_filename as commFilename,
			    comm_filepath as commFilepath,
			(select nvl(count(*),0) from communityco_tbl co where co.comm_no = comm.comm_no) as cmntCount
		from community_tbl comm where comm_no = ${value}
	</select> 
	
	<select id="readCountUp" parameterType="int">
		update community_tbl set read_count=read_count+1 where comm_no = ${value}
	</select> 
	
	<select id="selectCmntList" resultType="commCo" parameterType="int">
	select
			co.CMNT_NO as cmntNo,
			co.MEMBER_NO as memberNo,
			(select member_nick from member_tbl m where co.member_no = m.member_no) as memberNick, --멤버닉
			(select grade from member_tbl m where co.member_no = m.member_no) as memberGrade, --멤버등급
			(select member_picturepath from member_tbl m where co.member_no = m.member_no) as memberPicturepath, --멤버프로필사진
			co.CMNT_CONTENT as cmntContent,
			co.CMNT_DATE as cmntDate,
			co.COMM_NO as commNo,
			co.CMNT_REF as cmntRef,
            m.member_nick as cmntRefNick,
			co.CMNT_LEV AS cmntLev,
            co.CMNT_GROUP AS cmntGroup
		from communityco_tbl co
        left join communityco_tbl co2 on co.cmnt_ref = co2.cmnt_no
		left join member_tbl m on co2.member_no = m.member_no
 		where co.comm_no = ${value} order by co.CMNT_group ,co.cmnt_no
	</select> 

	<insert id="communityWrite" parameterType="comm">
		insert into community_tbl values(
			COMMUNITY_SEQ.nextval,
			#{commCategory},
			#{memberNo},
			#{commTitle},
			#{commIntro},
			#{commContent},
			#{advantage},
			#{weakness},
			0,
			TO_CHAR(SYSDATE, 'yyyy.mm.dd hh24:mi'),
   			0,
			#{commFilename},
			#{commFilename}
		)
	</insert>
	
	<update id="communityUpdate" parameterType="comm">
		update community_tbl set 
			comm_title = #{commTitle},
			comm_intro = #{commIntro},
			comm_content = #{commContent},
			advantage = #{advantage},
			weakness = #{weakness}
		<if test="commFilename != null">
			, comm_filename = #{commFilename},
			comm_filepath = #{commFilepath}
		</if>
		where comm_no = #{commNo}
	</update>

	<delete id="communityDelete" parameterType="int">
		delete from community_tbl 
			where comm_no = ${value}
	</delete>
</mapper>
